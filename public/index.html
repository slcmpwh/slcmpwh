<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>WareFlow — WMS Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
      :root{--bg:#f6f8fa;--card:#ffffff;--muted:#6b7280;--accent:#082f4a}
      *{box-sizing:border-box}body{font-family:Inter,system-ui,Arial,sans-serif;margin:0;background:var(--bg);color:#0f172a}
      .app{display:flex;min-height:100vh}
      .sidebar{width:260px;background:#fff;border-right:1px solid #e6eef6;padding:24px}
      .logo{display:flex;align-items:center;gap:12px;margin-bottom:18px}
      .logo .icon{background:#0ea5a3;width:44px;height:44;border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
      .nav{margin-top:18px}
      .nav button{display:block;width:100%;padding:10px 12px;border-radius:8px;border:none;background:transparent;text-align:left;color:#0f172a;margin-bottom:6px;cursor:pointer}
      .nav button.active{background:#0b79b6;color:#fff;font-weight:600}
      .main{flex:1;padding:28px 32px}
      .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
      .title h1{margin:0;font-size:28px}
      .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:18px;margin-bottom:18px}
      .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 1px 2px rgba(15,23,42,0.04)}
      .kpi{font-size:22px;font-weight:700}
      .muted{color:var(--muted);font-size:13px;margin-top:6px}
      .flex{display:flex;gap:12px;align-items:center}
      .layout{display:grid;grid-template-columns:2fr 1fr;gap:18px}
      table{width:100%;border-collapse:collapse}
      th,td{padding:12px;text-align:left;border-bottom:1px solid #eef2f7;font-size:14px}
      .small{font-size:13px;color:#475569}
      .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2f7;font-weight:600;color:#065f46}
      .alert-list .alert-item{border-radius:10px;padding:12px;background:#fff3cd;border:1px solid #ffe8a1;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
      .badge{background:#fde8e8;color:#b91c1c;padding:6px 10px;border-radius:8px;font-weight:700}
      .controls{display:flex;gap:8px}
      input,select{padding:8px;border-radius:8px;border:1px solid #e6eef6}
      button.primary{background:#0b79b6;color:#fff;border:none;padding:8px 12px;border-radius:8px}
    </style>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar">
        <div class="logo"><div class="icon">WF</div><div><div style="font-weight:700">WareFlow</div><div class="small">Warehouse Management</div></div></div>
        <nav class="nav">
          <button class="active" onclick="route('dashboard')">Dashboard</button>
          <button onclick="route('inventory')">Inventory</button>
          <button onclick="route('movements')">Movements</button>
          <button onclick="route('stockcount')">Stock Count</button>
          <button onclick="route('materials')">Materials</button>
          <button onclick="route('reports')">Reports</button>
        </nav>
      </aside>
      <main class="main">
        <div class="header">
          <div class="title"><h1>Warehouse Dashboard</h1><div class="muted">Real-time inventory overview</div></div>
          <div class="controls">
            <input id="search" placeholder="Search SKU or name" onkeyup="renderCurrent()" />
            <button class="primary" onclick="openReceive()">Receive</button>
            <!-- CSV Import -->
<input type="file" id="csvInput" accept=".csv" style="display:none" />
<button class="primary" onclick="document.getElementById('csvInput').click()">Import CSV</button>

          </div>
        </div>

        <div id="appContent">
          <!-- dynamic content -->
        </div>
      </main>
    </div>

    <script>
      let state = { items:[], locations:[], transactions:[], picklists:[] };
      async function api(path, opts={}){
        const res = await fetch('/api' + path, opts);
        return res.json();
      }
      async function loadState(){ state = await api('/state'); renderCurrent(); }
      function route(r){ window.currentRoute = r; renderCurrent(); document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); }
      function formatDate(d){ try{ return new Date(d).toLocaleString(); }catch(e){return d} }

      function lowStockItems(){ return (state.items||[]).filter(it => (it.minQty||0) > (it.qty||0)); }

      function dashboardHtml(){
        const total = state.items.length;
        const totalQty = state.items.reduce((a,b)=>a+(b.qty||0),0);
        const lowCount = lowStockItems().length;
        let recent = (state.transactions||[]).slice(-6).reverse();
        return `
          <div class="grid">
            <div class="card"><div class="muted">Total Materials</div><div class="kpi">${total}</div></div>
            <div class="card"><div class="muted">Inventory Value</div><div class="kpi">$NaN</div></div>
            <div class="card"><div class="muted">Today's Movements</div><div class="kpi">${recent.length}</div></div>
            <div class="card"><div class="muted">Low Stock Alerts</div><div class="kpi">${lowCount}</div></div>
          </div>
          <div class="layout">
            <div class="card">
              <h3 style="margin-top:0">Recent Movements</h3>
              <table><thead><tr><th>Type</th><th>Material</th><th>Quantity</th><th>Location</th><th>Date</th></tr></thead><tbody>
                ${recent.map(t=>`<tr><td>${t.type}</td><td>${t.itemId||''}</td><td class="small">${t.qty||''}</td><td class="small">${t.location||''}</td><td class="small">${formatDate(t.at)}</td></tr>`).join('')}
              </tbody></table>
            </div>
            <div class="card">
              <h3 style="margin-top:0">⚠️ Low Stock Alerts</h3>
              <div class="alert-list">
                ${lowStockItems().map(it=>`<div class="alert-item"><div><div style="font-weight:700">${it.id}</div><div class="small">${it.name}</div></div><div style="text-align:right"><div class="badge">${it.qty} EA</div><div class="small">Min: ${it.minQty||0}</div></div></div>`).join('')}
              </div>
            </div>
          </div>
        `;
      }

      function inventoryHtml(){
        return `
          <div class="card">
            <h3 style="margin-top:0">Inventory</h3>
            <table><thead><tr><th>SKU</th><th>Name</th><th>Qty</th><th>Location</th><th>Actions</th></tr></thead><tbody id="invRows"></tbody></table>
          </div>
          <div class="card">
            <h3 style="margin-top:0">Create / Receive</h3>
            <div style="display:flex;gap:8px">
              <input id="new_sku" placeholder="SKU" />
              <input id="new_name" placeholder="Name" />
              <input id="new_qty" type="number" value="1" style="width:90px" />
              <select id="new_loc">${state.locations.map(l=>`<option>${l}</option>`).join('')}</select>
              <input id="new_min" type="number" placeholder="Min qty" style="width:90px" />
              <button class="primary" onclick="createItem()">Save</button>
            </div>
          </div>
        `;
      }

      function renderCurrent(){
        const r = window.currentRoute || 'dashboard';
        const q = document.getElementById('search')?.value || '';
        const el = document.getElementById('appContent');
        if (r === 'dashboard'){ el.innerHTML = dashboardHtml(); }
        if (r === 'inventory'){ el.innerHTML = inventoryHtml(); renderInventoryTable(q); }
      }

      function renderInventoryTable(filter=''){
        const tbody = document.getElementById('invRows');
        if(!tbody) return;
        const rows = state.items.filter(it => !filter || it.id.includes(filter) || (it.name||'').toLowerCase().includes(filter.toLowerCase()));
        tbody.innerHTML = rows.map(it=>`<tr><td>${it.id}</td><td>${it.name}</td><td>${it.qty}</td><td>${it.location||'-'}</td><td><button onclick="adj('${it.id}',-1)">-1</button><button onclick="adj('${it.id}',1)">+1</button><button onclick="movePrompt('${it.id}')">Move</button></td></tr>`).join('');
      }

      async function openReceive(){ route('inventory'); await loadState(); document.getElementById('new_sku').focus(); }

      async function createItem(){
        const id = document.getElementById('new_sku').value.trim();
        const name = document.getElementById('new_name').value.trim();
        const qty = Number(document.getElementById('new_qty').value || 0);
        const loc = document.getElementById('new_loc').value;
        const min = Number(document.getElementById('new_min').value || 0);
        if(!id||!name){ alert('SKU and name required'); return; }
        await fetch('/api/items',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,name,qty,location:loc,minQty:min})});
        await loadState();
        renderCurrent();
      }

      async function adj(id, delta){
        await fetch('/api/inventory/adjust',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({itemId:id,delta})});
        await loadState(); renderCurrent();
      }
      function movePrompt(id){ const to = prompt('Move to location:'); if(to) move(id,to); }
      async function move(id,to){ await fetch('/api/move',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({itemId:id,to})}); await loadState(); renderCurrent(); }

      // initial load
      loadState();
    </script>
  </body>
</html>
