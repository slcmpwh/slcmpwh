<script>
document.getElementById('csvInput').addEventListener('change', handleCSVUpload);

async function handleCSVUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  const text = await file.text();
  const lines = text.split(/\r?\n/).filter(l => l.trim());
  const header = lines.shift().split(',');

  // Sütun indekslerini sizin dosyanıza göre ayarladım
  const idxId = header.indexOf('Material');
  const idxName = header.indexOf('Material Description');
  const idxQty = header.indexOf('Stock 2025/8/22');
  const idxLocation = header.indexOf('Storage Location');
  const idxMin = header.indexOf('Target Stock Level (Month)');

  let success = 0, fail = 0;

  for (const line of lines) {
    const cols = line.split(',');
    if (!cols.length) continue;
    const obj = {
      id: cols[idxId]?.trim(),
      name: cols[idxName]?.trim(),
      qty: parseInt(cols[idxQty]?.trim()) || 0,
      location: cols[idxLocation]?.trim() || '',
      minQty: parseInt(cols[idxMin]?.trim()) || 0,
    };
    try {
      const resp = await fetch('/api/items', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(obj),
      });
      if (resp.ok) success++;
      else fail++;
    } catch {
      fail++;
    }
  }

  alert(`Import complete: ${success} success, ${fail} failed.`);
  await loadState();
  renderCurrent();
}
</script>
